<%- include('fragments/header', { user: user }) %>

<div class="container py-5">
  <div class="row">
    <div class="col-lg-10 mx-auto">
      <div class="mb-5">
        <h1 class="display-4 mb-2">
          <i class="fas fa-sticky-note" style="color: #ff6b9d;"></i> Secret Notes
        </h1>
        <p class="text-muted">Keep your sweet little secrets and reminders here</p>
      </div>

      <!-- Create Note Section -->
      <div class="romantic-card p-4 mb-5">
        <h4 class="mb-3">
          <i class="fas fa-plus-circle"></i> Create New Note
        </h4>
        <form id="createNoteForm" class="needs-validation">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="noteTitle" class="form-label">Title</label>
              <input type="text" class="form-control romantic-input" id="noteTitle" name="title" placeholder="Note title" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="noteCategory" class="form-label">Category</label>
              <select class="form-control romantic-input" id="noteCategory" name="category">
                <option value="general">General</option>
                <option value="anniversary">Anniversary</option>
                <option value="reminder">Reminder</option>
                <option value="dreams">Dreams Together</option>
                <option value="bucket-list">Bucket List</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="noteContent" class="form-label">Note</label>
            <textarea class="form-control romantic-input" id="noteContent" name="content" rows="4" placeholder="Write your note here..." required></textarea>
          </div>
          <button type="submit" class="btn romantic-btn btn-lg w-100">
            <i class="fas fa-save"></i> Save Note
          </button>
        </form>
      </div>

      <!-- Notes Display -->
      <div id="notesContainer">
        <% if (notes && notes.length > 0) { %>
          <div class="row g-3">
            <% notes.forEach(note => { %>
              <div class="col-md-6">
                <div class="card romantic-card h-100 note-card">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <h5 class="card-title mb-1"><%= note.title %></h5>
                        <small class="badge romantic-badge"><%= note.category %></small>
                      </div>
                    </div>
                    <p class="card-text"><%= note.content.substring(0, 150) %>...</p>
                    <small class="text-muted d-block mt-3">
                      <i class="fas fa-clock"></i> <%= new Date(note.created_at).toLocaleDateString() %>
                    </small>
                    <div class="mt-3">
                      <button class="btn btn-sm btn-outline-primary me-2" onclick="editNote('<%= note.id %>', '<%= note.title %>', '<%= note.category %>', '<%= note.content.replace(/'/g, "\\'") %>')">
                        <i class="fas fa-edit"></i> Edit
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteNote(<%= note.id %>)">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="text-center p-5 romantic-card">
            <i class="fas fa-note-sticky" style="font-size: 4rem; color: #ddd;"></i>
            <p class="text-muted mt-3">No notes yet. Start by creating your first note!</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%- include('fragments/footer') %>

<script>
document.getElementById('createNoteForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  try {
    const response = await fetch('/notes/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    if (response.ok) {
      alert('Note saved!');
      document.getElementById('createNoteForm').reset();
      location.reload();
    } else {
      alert('Error saving note');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error saving note');
  }
});

async function deleteNote(noteId) {
  if (confirm('Are you sure you want to delete this note?')) {
    try {
      const response = await fetch(`/notes/${noteId}`, { method: 'DELETE' });
      if (response.ok) {
        alert('Note deleted');
        location.reload();
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error deleting note');
    }
  }
}

function editNote(id, title, category, content) {
  document.getElementById('noteTitle').value = title;
  document.getElementById('noteCategory').value = category;
  document.getElementById('noteContent').value = content;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
