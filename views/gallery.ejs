<%- include('fragments/header', { user: user }) %>

<div class="container py-5">
  <div class="row">
    <div class="col-lg-10 mx-auto">
      <div class="mb-5">
        <h1 class="display-4 mb-2">
          <i class="fas fa-images" style="color: #ff6b9d;"></i> Photo Gallery
        </h1>
        <p class="text-muted">Capture and cherish every beautiful moment together</p>
      </div>

      <!-- Upload Section -->
      <div class="romantic-card p-4 mb-5">
        <h4 class="mb-3">
          <i class="fas fa-camera"></i> Add New Photo
        </h4>
        <form id="uploadForm" class="needs-validation">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="photoTitle" class="form-label">Photo Title</label>
              <input type="text" class="form-control romantic-input" id="photoTitle" name="title" placeholder="e.g., Our first kiss">
            </div>
            <div class="col-md-6 mb-3">
              <label for="photoDate" class="form-label">Date</label>
              <input type="date" class="form-control romantic-input" id="photoDate" name="photoDate">
            </div>
          </div>
          <div class="mb-3">
            <label for="photoDescription" class="form-label">Description</label>
            <textarea class="form-control romantic-input" id="photoDescription" name="description" rows="2" placeholder="Tell the story behind this photo..."></textarea>
          </div>
          <div class="mb-3">
            <label for="photoFile" class="form-label">Choose Photo</label>
            <input type="file" class="form-control romantic-input" id="photoFile" name="photo" accept="image/*" required>
            <small class="text-muted">Max 10MB. Supported: JPG, PNG, GIF</small>
          </div>
          <button type="submit" class="btn romantic-btn btn-lg w-100">
            <i class="fas fa-upload"></i> Upload Photo
          </button>
        </form>
      </div>

      <!-- Gallery Grid -->
      <div id="galleryContainer">
        <% if (photos && photos.length > 0) { %>
          <div class="row g-3">
            <% photos.forEach(photo => { %>
              <div class="col-md-6 col-lg-4">
                <div class="card romantic-card photo-card">
                  <img src="/uploads/<%= photo.filename %>" class="card-img-top photo-img" alt="<%= photo.title %>">
                  <div class="card-body">
                    <h5 class="card-title"><%= photo.title || 'Untitled' %></h5>
                    <p class="card-text text-muted small"><%= photo.description || 'No description' %></p>
                    <small class="text-muted">
                      <i class="fas fa-calendar"></i> <%= photo.photo_date || 'No date' %>
                    </small>
                    <div class="mt-3">
                      <button class="btn btn-sm btn-outline-danger" onclick="deletePhoto(<%= photo.id %>)">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="text-center p-5 romantic-card">
            <i class="fas fa-image" style="font-size: 4rem; color: #ddd;"></i>
            <p class="text-muted mt-3">No photos yet. Start by uploading your first memory!</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%- include('fragments/footer') %>

<script>
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  
  try {
    const response = await fetch('/gallery/upload', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      const result = await response.json();
      alert('Photo uploaded successfully!');
      document.getElementById('uploadForm').reset();
      location.reload();
    } else {
      alert('Error uploading photo');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error uploading photo');
  }
});

async function deletePhoto(photoId) {
  if (confirm('Are you sure you want to delete this photo?')) {
    try {
      const response = await fetch(`/gallery/${photoId}`, { method: 'DELETE' });
      if (response.ok) {
        alert('Photo deleted');
        location.reload();
      } else {
        alert('Error deleting photo');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error deleting photo');
    }
  }
}
</script>
